#!/bin/bash
# get EZDPL_HOME
if [[ -z ${EZDPL_HOME} ]]; then
    _dir=$(dirname `readlink -f $0`)
    cd $_dir && cd ..
    EZDPL_HOME=`pwd`
fi
echo "EZDPL_HOME=$EZDPL_HOME"
echo

_target=$1
set -u 
_time_start=`date +%F_%T`
echo $_time_start

if [[ -n $_target ]]; then
    # _target='x.x.x.x web-02 root 22'
    _servers=$_target
elif [[ -f ${EZDPL_HOME}/hosts.lst ]]; then
    _servers=`egrep -v '(^ *#|^$)' ./hosts.lst`
else
    # mysql/sqlite version
    _where=" "
    _servers=`${EZDPL_HOME}/bin/sqlezdpl "SELECT ip , name , user, port FROM srv $_where" | egrep -v 'name.*port' `
fi

#echo "$_servers"

IFS=$'\n'
echo "Server Resource:"
_mem_limit=80
echo -e "Host\tOS\tCPUs\tCPU_load\tMemTotal\tMemUsed%\tDiskUsage"
for x in $_servers;do
    	_centos6=""
	_centos7=""
	_os=""
    	_ip=`echo $x|awk '{print $1}'`
    	_host=`echo $x|awk '{print $2}'`
	_user=`echo $x|awk '{print $3}'`
    	_port=`echo $x|awk '{print $4}'`
	if [[ -z $_host ]] || [[ -z $_port ]]; then
	    echo "Host/Port missing"
	    continue
	fi
	_raw_df=`ssh $_user@$_ip -p $_port "df -hTPl |egrep '(5.%|6.%|7.%|8.%|9.%|100%)'" 2>/dev/null`
  	_str=`ssh $_user@$_ip -p $_port "\
	nproc ;\
	echo '|' ;\
	uptime|grep 'load average' ;\
	echo '|' ;\
	egrep 'CentOS release 6\.' /etc/redhat-release ;\
	echo '|' ;\
	egrep 'CentOS Linux release 7\.' /etc/redhat-release ;\
	echo '|' ;\
      	free -tm |grep "Mem:" ;\
	" 2>/dev/null`
	if [[ $? != 0 ]]; then
	    echo "$_host($_ip) unreachable."
	    continue
	fi
	#Extract data
	_cpu_count=`echo $_str|awk -F'|' '{print $1}'`
	_cpu_load=` echo $_str|awk -F'|' '{print $2}'|awk -F': ' '{print $2}'`
	_centos6=`  echo $_str|awk -F'|' '{print $3}'|tr -d [:blank:]`
	_centos7=`  echo $_str|awk -F'|' '{print $4}'|tr -d [:blank:]`
	_mem_info=` echo $_str|awk -F'|' '{print $5}'`
	_load_1=`echo $_cpu_load|awk -F', ' '{print $1}'`
	_load_5=`echo $_cpu_load|awk -F', ' '{print $2}'`
	_load_15=`echo $_cpu_load|awk -F', ' '{print $3}'`
	_mem_total=`echo $_mem_info|awk '{print $2}'`
	_mem_used_raw=`echo $_mem_info |awk '{print $3}'`

	if [[ -n $_centos6 ]]; then
	    _os=c6
	    _mem_buffers=`echo $_mem_info |awk '{print $6}'`
	    _mem_cached=` echo $_mem_info |awk '{print $7}'` 
	    _mem_used=`echo "$_mem_used_raw - $_mem_buffers - $_mem_cached"|bc`
	elif [[ -n $_centos7 ]]; then
	    _os=c7
	    _mem_used=$_mem_used_raw
	fi
	_mem_percent=`echo "scale=2;ibase=10;obase=10;$_mem_used/$_mem_total*100"|bc|sed 's/.00//g'`

	if [[ $_mem_percent -gt $_mem_limit ]]; then
	    _mem_percent="\033[31m$_mem_percent\033[0m"
	fi

	_df=`echo "$_raw_df"|awk '{print $7" "$6"  "}'|tr -d ['\n']`
	echo -e "${_host}\t${_os}\t${_cpu_count}\t${_cpu_load}\t${_mem_total}\t${_mem_percent}%\t${_df}"

done

echo "Server Ports"
echo -e "Host(Ip Address)\t80\t8000\t8080\t8888\t9000\t11211\t6379\t27017\t3306\t61616\t5672"
for x in $_servers;do
        _centos6=""
        _centos7=""
        _os=""
        _ip=`echo $x|awk '{print $1}'`
        _host=`echo $x|awk '{print $2}'`
        _user=`echo $x|awk '{print $3}'`
        _port=`echo $x|awk '{print $4}'`
        if [[ -z $_host ]] || [[ -z $_port ]]; then
            echo "Host/Port missing"
            continue
        fi
	_ports_info=`ssh $_user@$_ip -p $_port "ss -lnt"`
	#echo "$_ports_info"
	echo -en "$_host($_ip)\t"
	for y in 80 8000 8080 8888 9000 11211 6379 27017 3306 61616 5672;do 
	    if echo "$_ports_info"|egrep ":$y " &>/dev/null;then
		echo -en "OK\t"
	    else
		echo -en "-\t"
	    fi
	done
	echo
done
_time_end=`date +%F_%T` 
echo $_time_end
echo 

# Sample
# Server Resource:
# Host	OS	CPUs	CPU_load	MemTotal	MemUsed%	DiskUsage
# c20	c7	4 	0.00, 0.01, 0.05 	7856	32%	   
# Server Ports
# Host(Ip Address)	80	8000	8080	8888	9000	11211	6379	27017	3306	61616	5672
# c20(172.16.33.20)	OK	OK	OK	OK	-	-	OK	-	OK	-	-	

#free format
#6
# free -tm
#1		2	  3	     4	      5	         6	    7
#             total       used       free     shared    buffers     cached
#Mem:         15888      15796         91          0        309       5380
#-/+ buffers/cache:      10106       5781
#Swap:          991        773        218
#Total:       16880      16569        310

#7
# free -tm
#1		2	     3	        4	   5	         6	    7
#              total        used        free      shared  buff/cache   available
#Mem:          15940        4439         908         361       10592       10830
#Swap:          9767          18        9749
#Total:        25708        4457       10658

